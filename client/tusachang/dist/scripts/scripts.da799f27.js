"use strict";var urlPrefix="";angular.module("tusachangApp",["ngMaterial","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.router"]).filter("trusted",["$sce",function(a){return function(b){return a.trustAsResourceUrl(b)}}]).config(["$mdThemingProvider","$mdIconProvider","$routeProvider","$stateProvider","$httpProvider",function(a,b,c,d,e){b.icon("person","./images/person.29700ffb.svg").icon("login","./images/logout.f661d10c.svg").icon("refresh","./images/refresh.6e4a1cf5.svg"),a.theme("default").primaryPalette("blue").accentPalette("orange"),d.state("bookshelf",{url:"/bookshelf",templateUrl:"views/bookshelf.html",controller:"BookshelfCtrl as bookshelf"}).state("createBook",{url:"/createBook",templateUrl:"views/createbook.html",controller:"CreateBookCtrl as creator"})}]),angular.module("tusachangApp").factory("myHttpResponseInterceptor",["$q","$rootScope",function(a,b){return{responseError:function(c){return 401==c.status&&b.$emit("authentication","sessionExpired"),a.reject(c)}}}]),angular.module("tusachangApp").directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){console.log("ngEnter - key:"+b.which),13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),angular.module("tusachangApp").service("BookService",["$rootScope","$http",function(a,b){var c=this;c.sites=[],c.loadSites=function(a){c.sites.length>0&&a(!0,c.sites),console.log("loading sites...");var d={headers:{"Content-Type":"application/json"}};b.get(urlPrefix+"/api/sites",d).success(function(b,d){console.log("BookService.loadSites() - success response, status:"+d,b),200===d&&b?(c.sites=b,a&&a(!0,c.sites)):a&&a(!1,"Failed to load sites, status="+d)}).error(function(b,c){console.log("BookService.loadSites() - error response, status:"+c),a&&a(!1,"Failed to load sites, status="+c)})},c.loadBooks=function(a){console.log("loading all books...");var d={headers:{"Content-Type":"application/json"}};b.get(urlPrefix+"/api/books/0",d).success(function(b,d){console.log("BookService.loadBooks() - success response, status:"+d,b),200===d&&b?(c.books=b,c.books.sort(function(a,b){return a.lastUpdatedTime>b.lastUpdatedTime?-1:a.lastUpdatedTime<b.lastUpdatedTime?1:0}),a(!0,c.books)):a(!1,"Failed to load books, status="+d)}).error(function(b,c){console.log("BookService.loadBooks() - error response, status:"+c),a(!1,"Failed to load books, status="+c)})},c.loadBook=function(a,d){console.log("download book: "+a);var e={headers:{"Content-Type":"application/json"}};b.get(urlPrefix+"/api/books/0",e).success(function(a,b){console.log("BookService.loadBooks() - success response, status:"+b,a),200===b&&a?(c.books=a,c.books.sort(function(a,b){return a.lastUpdatedTime>b.lastUpdatedTime?-1:a.lastUpdatedTime<b.lastUpdatedTime?1:0}),d(!0,c.books)):d(!1,"Failed to load books, status="+b)}).error(function(a,b){console.log("BookService.loadBooks() - error response, status:"+b),d(!1,"Failed to load books, status="+b)})},c.updateBook=function(a,c,d){console.log(c+" book: "+a);var e={headers:{"Content-Type":"application/json"}};b.post(urlPrefix+"/api/book/"+c,a,e).success(function(a,b){console.log("BookService.updateBook() - success response, status:"+b,a),200===b&&a?d(!0,a):d(!1,"Failed to "+c+" book, status="+b)}).error(function(a,b){console.log("BookService.updateBook() - error response, status:"+b,a),d(!1,"Failed to "+c+" book, status="+b)})}}]),angular.module("tusachangApp").service("LoginService",["$rootScope","$cookies","$http",function(a,b,c){var d=this;a.logonUser={name:"",role:"",sessionId:""};var e=b.get("tusachangApp.sessionid");void 0!=e&&null!=e&&""!=e&&(a.logonUser.sessionId=e),a.isLogin=!1,console.log("login-service - isLogin:"+a.isLogin+", sessionId:"+a.logonUser.sessionId),d.doValidateSession=function(b){var e={headers:{"Content-Type":"application/json"}};c.get(urlPrefix+"/api/user/"+a.logonUser.sessionId,e).success(function(c,e){console.log("doValidateSession, status:"+e+", ",c),200==e&&c&&c.sessionId&&""!=c.sessionId&&(a.logonUser=c,a.isLogin=!0),d.updateCookie(a.isLogin),a.$emit("authentication"),b&&b(200==e,e)}).error(function(c,e){d.updateCookie(!1),a.$emit("authentication"),b&&b(!1,e)})},""!=a.logonUser.sessionId&&d.doValidateSession(null),d.doLogin=function(b,e,f){console.log("doLogin - urlPrefix:"+urlPrefix);var g={name:b,password:e},h={headers:{"Content-Type":"application/json"}};a.isLogin=!1,a.logonUser.sessionId="",a.logonUser.name="",c.post(urlPrefix+"/api/login",g,h).success(function(b,c){var e="";200==c&&b&&b.sessionId&&""!=b.sessionId?(console.log("success login, status:"+c+", data:",b),a.logonUser=b,a.isLogin=!0,a.$emit("authentication")):(e="Error logging in to server: "+c,b&&(e=b.status),console.log("error login, status:"+c+", msg:"+e)),f(a.isLogin,e),d.updateCookie(a.isLogin)}).error(function(a,b){console.log("error login, status:"+b+", data:",a);var c="Error logging in to server: "+b;f(!1,c),d.updateCookie(!1)})},d.doLogout=function(b){d.updateCookie(!1);var e={headers:{"Content-Type":"application/json"}};c.post(urlPrefix+"/api/logout/"+a.logonUser.sessionId,e).success(function(a,c){console.log("success logout, status:"+c),b&&(a?b(200==c,a.status):b(!1,"Failed to logout, status="+c))}).error(function(a,c){console.log("error logout, status:"+c),b&&b(!1,"Failed to logout, status="+c)}),a.$emit("authentication","logout")},d.updateCookie=function(c){if(c){var d=new Date,e=36e5;d.setDate(d.getTime()+e),b.put("tusachangApp.sessionid",a.logonUser.sessionId,{expires:d})}else b.remove("tusachangApp.sessionid"),a.logonUser.sessionId="",a.logonUser.name="",a.isLogin=!1}}]),angular.module("tusachangApp").controller("MainCtrl",["$rootScope","$state","$scope","LoginService",function(a,b,c,d){var e=this;e.username="",e.password="";var f={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return f.Android()||f.BlackBerry()||f.iOS()||f.Opera()||f.Windows()}};console.log("isMobile: "+f.any()),e.desktopMode=1!=f.any,a.desktopMode=e.desktopMode,c.$watch(function(a){return e.desktopMode},function(b){console.log("desktopMode changed, newValue: "+e.desktopMode),a.desktopMode=e.desktopMode}),a.$on("authentication",function(c,e){console.log("received event: "+c+", data:"+e+", isLogin:"+a.isLogin);var f="";"sessionExpired"==e&&(d.updateCookie(!1),f="Your session has expired!"),1!=a.isLogin&&"bookshelf"!=b.current.name&&b.go("bookshelf",{message:f})}),e.signInOut=function(){1!=a.isLogin?(console.log("sign in with "+e.username+"/"+e.password),d.doLogin(e.username,e.password,function(a,b){a||console.log("Failed to login! "+b)})):d.doLogout(function(a,b){})}}]),angular.module("tusachangApp").controller("LoginCtrl",["$rootScope","$scope","$stateParams","$interval","LoginService",function(a,b,c,d,e){var f=this;console.log("LoginCtrl ..."),b.username="",b.password="",b.statusMessage=c.message,b.statusType=""!=b.statusMessage?"error":"info",b.rebooting=c.rebooting===!0,b.rebooting&&(b.monitorTimer=d(function(){console.log("validating session with server..."),e.doValidateSession(function(a,b){(200==b||401==b)&&f.stopTimer()})},1e4)),b.$on("$destroy",function(){f.stopTimer()}),b.doLogin=function(){b.statusType="info",b.statusMessage="Authenticating with server...",e.doLogin(b.username,b.password,function(c,d){b.statusType=a.isLogin?"info":"error",b.statusMessage=d})},f.stopTimer=function(){b.rebooting=!1,b.monitorTimer&&(d.cancel(b.monitorTimer),b.monitorTimer=null)}}]),angular.module("tusachangApp").controller("BookshelfCtrl",["$rootScope","$state","$scope","$mdBottomSheet","BookService",function(a,b,c,d,e){var f=this;f.books=[],f.loading=!1,f.statusMessage="",f.statusType="info",f.load=function(){f.statusMessage="Loading books from server...",f.loading=!0,e.loadBooks(function(a,b){if(f.loading=!1,a){f.books=b;for(var c=0;c<f.books.length;c++)f.books[c].titleSummary=f.books[c].title+" ("+f.books[c].currentPageNo+"/"+f.books[c].maxNumPages+")";f.statusMessage=f.books.length+" books loaded"}else f.statusMessage="Error loading books: "+b,f.statusType="error"})},f.load(),f.select=function(b){console.log("select book: ",b),a.desktopMode&&(a.selectedBook=b,d.show({templateUrl:"views/bookdetail.html",controller:"BookDetailCtrl"}))},f.getDownloadLink=function(a){return urlPrefix+"/downloadBook/"+a.title+".epub?bookId="+a.id},a.$on("reload",function(){"bookshelf"==b.current.name&&f.load()})}]),angular.module("tusachangApp").controller("BookDetailCtrl",["$rootScope","$state","$scope","$mdBottomSheet","BookService",function(a,b,c,d,e){var f=this;c.loading=!1,c.statusMessage="",c.statusType="info",c.book=a.selectedBook,console.log("book detail: "+c.book),c.book.statusSummary=c.book.status,"ERROR"==c.book.status&&(c.book.statusSummary+=" ("+c.book.errorMsg+")"),c.download=function(){window.location=urlPrefix+"/downloadBook/"+c.book.title+".epub?bookId="+c.book.id},c.canUpdate=function(b){return"download"==b?!0:"WORKING"==book.status||!a.isLogin||a.logonUser.name!=c.book.createdBy&&-1==a.logonUser.role.indexOf("admin")?!1:!0},c.update=function(a){c.loading=!0,e.updateBook(c.book,a,function(a,b){c.loading=!1,a?(f.statusMessage=b,f.statusType="error"):f.statusMessage=""})}}]),angular.module("tusachangApp").controller("CreateBookCtrl",["$rootScope","$state","$scope","$mdBottomSheet","BookService",function(a,b,c,d,e){var f=this;f.loading=!1,f.sites=[],f.books=[],f.firstChapterURL="",f.title="",f.author="",f.numPages=0,f.statusMessage="",f.statusType="info",f.create=function(){f.statusMessage="Creating book...",f.statusType="info";var a={startPageUrl:f.firstChapterURL,title:f.title,author:f.author,maxNumPages:f.numPages};e.updateBook(a,"create",function(a,b){a?(f.statusMessage=b,f.statusType="error"):f.statusMessage=""})},f.abort=function(a){},f.load=function(){f.loading=!0,e.loadSites(function(a,b){a&&(f.sites=b)}),e.loadBooks(function(a,b){f.loading=!1,f.books=[];for(var c=0;c<b.length;c++)"WORKING"==b.status&&(f.books.push(b[c]),b[c].details=b[c].status+" ("+b[c].currentPageNo+"/"+b[c].maxNumPages+")")})},f.load()}]),angular.module("tusachangApp").run(["$templateCache",function(a){a.put("views/bookdetail.html",'<md-bottom-sheet class="md-has-header"> <md-subheader>{{book.title}}</md-subheader> <md-progress-linear ng-if="loading" md-mode="indeterminate"></md-progress-linear> <span ng-if="statusMessage.length > 0" class="{{statusType}}Message-bookshelf">{{bookshelf.statusMessage}}</span> <div layout="column" layout-align="center center"> <div flex layout="row" class="row-bookdetail"> <md-input-container class="field-bookdetail-first"> <label>Title</label> <input ng-model="book.title"> </md-input-container> <md-input-container class="field-bookdetail-second"> <label>Author</label> <input ng-model="book.author"> </md-input-container> </div> <div flex layout="row" class="row-bookdetail"> <md-input-container class="field-bookdetail-first"> <label>Last Update Time</label> <input readonly ng-model="book.lastUpdatedTime"> </md-input-container> <md-input-container class="field-bookdetail-remaining"> <label>Status</label> <input readonly ng-model="book.statusSummary"> </md-input-container> </div> <div flex layout="row" class="row-bookdetail"> <md-input-container class="field-bookdetail-first"> <label>Current Page No</label> <input readonly ng-model="book.currentPageNo"> </md-input-container> <md-input-container class="field-bookdetail-second"> <label>Max Num Pages</label> <input ng-model="book.maxNumPages"> </md-input-container> </div> <md-input-container class="row-bookdetail"> <label>Start Page URL</label> <input readonly ng-model="book.startPageUrl"> </md-input-container> <md-input-container class="row-bookdetail"> <label>Current Page URL</label> <input ng-model="book.currentPageUrl"> </md-input-container> <div> <md-button ng-if="book.status != \'WORKING\' && book.epubCreated" ng-click="download()" class="md-raised md-primary">Download</md-button> <md-button ng-if="canUpdate(\'delete\')" ng-click="update(\'delete\')" class="md-raised md-warn">Delete</md-button> <md-button ng-if="canUpdate(\'resume\')" ng-click="update(\'resume\')" class="md-raised md-primary">Resume</md-button> <md-button ng-if="canUpdate(\'update\')" ng-click="update(\'update\')" class="md-raised md-primary">Save Changes</md-button> </div> </div> </md-bottom-sheet>'),a.put("views/bookshelf.html",'<div class="panel-bookshelf" flex> <md-progress-linear ng-if="bookshelf.loading" md-mode="indeterminate"></md-progress-linear> <span ng-if="bookshelf.statusMessage.length > 0" class="{{bookshelf.statusType}}Message-bookshelf">{{bookshelf.statusMessage}}</span> <md-grid-list md-cols-sm="2" md-cols-md="4" md-cols-lg="6" md-cols-gt-lg="8" md-row-height="100px" md-gutter="4px" md-gutter-gt-sm="4px"> <md-grid-tile ng-repeat="book in bookshelf.books" md-colspan="1"> <md-button ng-if="$root.desktopMode" ng-click="bookshelf.select(book)" aria-label="{{book.title}}"> <img src="/images/book.a42b01ac.png"> </md-button> <md-button ng-if="!$root.desktopMode" ng-href="{{bookshelf.getDownloadLink(book)}}" aria-label="{{book.title}}"> <img src="/images/book.a42b01ac.png"> </md-button> <md-grid-tile-footer layout-align="center" class="grid-book-title">{{book.titleSummary}}</md-grid-tile-footer> </md-grid-tile> </md-grid-list> </div>'),a.put("views/createbook.html",'<div class="panel-createbook" layout="column" flex> <md-progress-linear ng-if="creator.loading" md-mode="indeterminate"></md-progress-linear> <span ng-if="creator.statusMessage.length > 0" class="{{creator.statusType}}Message-bookshelf">{{creator.statusMessage}}</span> <div>Supported Sites:</div> <div layout="row" style="margin-left:10px"> <a ng-repeat="site in creator.sites" href="{{site}}" target="_blank" style="margin-right:10px; margin-top:10px; margin-bottom:10px">{{site}}</a> </div> <md-divider></md-divider> <div layout="row"> <md-input-container style="width:400px; max-width:500px"> <label>First Chapter URL</label> <input ng-model="creator.firstChapterURL"> </md-input-container> <md-input-container style="margin-left:50px; width:400px; max-width:500px"> <label>Title</label> <input ng-model="creator.title"> </md-input-container> </div> <div layout="row"> <md-input-container style="width:400px; max-width:500px"> <label>Author</label> <input ng-model="creator.author"> </md-input-container> <md-input-container style="margin-left:50px; width:400px; max-width:500px"> <label>Num Pages</label> <input ng-model="creator.numPages"> </md-input-container> </div> <div> <md-button ng-click="creator.create()" class="md-raised md-primary">Create</md-button> </div> <span ng-if="statusMessage.length > 0" class="{{statusType}}-message">{{statusMessage}}</span> <md-divider></md-divider> <md-content> <md-list> <md-subheader class="md-no-sticky">Pending Books</md-subheader> <md-list-item class="md-2-line" ng-repeat="book in creator.books"> <md-button ng-click="creator.abort(book)" aria-label="Abort"> <img src="/images/abort.png"> </md-button> <div class="md-list-item-text" layout="column"> <h4>{{ book.title }}</h4> <p>{{ book.status }}</p> </div> </md-list-item> </md-list> </md-content> </div>')}]);